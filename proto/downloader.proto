syntax = "proto3";

// import "google/protobuf/timestamp.proto";
// import "google/protobuf/duration.proto";
import "google/protobuf/empty.proto";

option go_package = ".;proto";

service DownloadService {
  // 初始化插件
  rpc Init(google.protobuf.Empty) returns (google.protobuf.Empty) {}
  // 更新插件配置
  rpc Update(google.protobuf.Empty) returns (google.protobuf.Empty) {}
  // 关闭插件
  rpc Shutdown(google.protobuf.Empty) returns (google.protobuf.Empty) {}

  // 获取
  rpc GetInfo(InfoRequest) returns (InfoResponse) {}

  rpc Parse(ParseRequest) returns (ParseResponse) {}

  rpc Download(DownloadRequest) returns (stream DownloadProgress) {}

  rpc StopDownload(StopDownloadRequest) returns (StopDownloadResponse) {}
}

// ---------------------------- 请求 ----------------------------

message InfoRequest {
  string url = 1; // 下载链接
}

message ParseRequest {
  string id = 1; // 暂时没用
  repeated Task tasks = 2;
}

message DownloadRequest {
  string id = 1; // 暂时没用
  repeated Task tasks = 2;
}

message StopDownloadRequest {
  string id = 1; // 任务ID
}

// ---------------------------- Responses ----------------------------

message InfoResponse {
  string title = 1;        // 系列标题
  string cover = 2;        // 封面
  string author = 3;       // 作者
  repeated Task tasks = 4; // 任务列表
}

message DownloadProgress {
  string id = 1;               // 任务ID
  int64 bytes_transferred = 2; // Number of bytes transferred.
  int64 total_bytes = 3;       // Total number of bytes to be transferred.
  string speed = 4;            // Current download speed.
}

message ParseResponse {
  string id = 1; // 暂时没用(可以用于检测是否请求成功)
  repeated Task tasks = 2;
}

message StopDownloadResponse {
  string id = 1;
  string state = 2;
}

// ---------------------------- Models ----------------------------
// 下载任务
message Task {
  string id = 1;
  string url = 2;
  string session_id = 3;
  string title = 4;
  repeated Segment segments = 5;
}

// 资源片段
message Segment {
  string mime_type = 2;
  repeated Format formats = 3;
}

// 资源格式
message Format {
  string id = 1;
  int64 fid = 2;        //  format Identifier.
  string mime_type = 3; // MIME type of the format.
  string label = 4;     // Media label (e.g., "720p").
  string code = 5;      //  (e.g., "mp4/mov","flac/mp3","png/jpg").
  string url = 6;       // URL for downloading this format.
}
